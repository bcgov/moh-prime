<app-page [busy]="busy">
  <app-expiry-alert [expiryDates]="organizationSitesExpiryDates">
    <!-- Work around for ngProjectAs not passing class reference to alert when applied to ng-content -->
    <ng-container #alertTitle
                  class="alert-title">
      One or more sites requires renewal.
    </ng-container>
    <ng-container #alertContent
                  class="alert-content">
      Review information and upload a valid business licence for site(s) indicated below.
    </ng-container>
  </app-expiry-alert>

  <app-page-header>Site Management</app-page-header>

  <ng-container *ngFor="let code of careSettingCodesPendingTransfer">
    <app-alert type="danger"
               icon="warning">
      <ng-container #alertTitle
                    class="alert-title">
        Required Action: Sign Organization Agreement
      </ng-container>
      <ng-container #alertContent
                    class="alert-content">
        You are required to sign the <strong>{{ CareSettingEnum[code] | replace: '_':' ' | capitalize: true }} Organization
          Agreement</strong>. Please follow the link below to read and sign the agreement before being granted
        permission to edit and view this organization.
        <br/>
        <a class="org_agreement_link" [routerLink]="" (click)="routeToOrgAgreementByCareSettingCode(code)">Go to Organization Agreement</a>
      </ng-container>
    </app-alert>
  </ng-container>

  <section class="mb-3">
    <app-page-subheader2>
      <ng-container appPageSubheader2Summary>
        Use this management page to update your information or to add multiple sites.
        <em class="emphasize">
          A site is a physical address in combination with a PharmaNet software vendor. If you use multiple vendors at
          one location, you have multiple sites.
        </em>
      </ng-container>
    </app-page-subheader2>
  </section>

  <ng-container *ngIf="organization">
    <div class="row mb-2">
      <div class="text-left col-6">
        Current Organization:
        <ng-container *ngIf="organizations.length > 1">
          <button mat-raised-button
                  color="secondary"
                  [matMenuTriggerFor]="orgMenu">
            {{ organization.name }}
            {{ organization.hasClaim ? ' (Pending)' :
            ''}}<mat-icon>keyboard_arrow_down</mat-icon>
          </button>
        </ng-container>
        <span *ngIf="organizations.length === 1"
             class="button mat-raised-button">
          {{ organization.name }}{{ organization.hasClaim ? ' (Pending)' :
            ''}}
        </span>
        <mat-menu #orgMenu="matMenu"
                  aria-label="Change Organization">
          <ng-container *ngFor="let org of organizations">
            <button *ngIf="org.id !== organization.id"
                    mat-menu-item
                    (click)="changeOrganization(org.id )">
              <span>{{ org.name }}{{ org.hasClaim ? ' (Pending)' :
            ''}}</span>
            </button>
          </ng-container>
        </mat-menu>
      </div>
      <div class="text-right col-6">
        <button mat-button
                type="button"
                color="primary"
                [disabled]="!canAddOrClaimOrganization()"
                (click)="addOrganization()">
          <mat-icon>add_business</mat-icon>
          Add Organization
        </button>
        <button mat-button
                type="button"
                color="primary"
                [disabled]="!canAddOrClaimOrganization()"
                (click)="claimOrganization()">
          <mat-icon>add_business</mat-icon>
          Claim Organization
        </button>
      </div>
    </div>

    <app-summary-card icon="business"
                      title="Organization Information"
                      [menu]="organizationMenu"
                      [menuOutletContext]="{ organization: organization }"
                      [properties]="getOrganizationProperties(organization)">
    </app-summary-card>

    <div *ngIf="organization.hasClaim">
      <div class="mb-4">
        <app-alert type="success"
                   icon="check_circle_outline">
          <ng-container #alertTitle
                        class="alert-title">
            You have claimed this Organization
          </ng-container>
        </app-alert>
      </div>

      <section class="mb-3">
        <app-page-subheader2>
          <ng-container appPageSubheader2Title>Organization Claim</ng-container>
          <ng-container appPageSubheader2Summary>
            <p>
              You have claimed this organization as the new Signing Authority. If you are approved, you will be able
              to update site information and add new sites for your organization. It may take several business days for
              approval. You will be notified via the email address you provided.
            </p>
          </ng-container>
        </app-page-subheader2>
      </section>
    </div>

    <div *ngIf="!organization.hasClaim">
      <hr class="divider">
      <div class="add-site">
        <button mat-button
                type="button"
                color="primary"
                [disabled]="orgHasPendingTransferOrClaim()"
                (click)="addSite(organization.id)">
          <mat-icon>add_business</mat-icon>
          Add Site
        </button>
      </div>

      <ng-container *ngFor="let site of organization.sites">

        <app-summary-card icon="store"
                          title="Site Information"
                          [menu]="siteMenu"
                          [menuOutletContext]="{ site: site, organizationId: organization.id }"
                          [properties]="getSiteProperties(site)"
                          (action)="viewSiteRemoteUsers(organization.id, site)">
          <ng-container *ngIf="inComplete(site)"
                        [ngTemplateOutlet]="notification"
                        [ngTemplateOutletContext]="{
                          props: getNotSubmittedSiteNotificationProperties(organization.id, site)
                        }">
          </ng-container>
          <ng-container *ngIf="isInReview(site)"
                        [ngTemplateOutlet]="notification"
                        [ngTemplateOutletContext]="{
                          props: getInReviewSiteNotificationProperties(site)
                        }">
          </ng-container>
          <ng-container *ngIf="isLocked(site)"
                        [ngTemplateOutlet]="notification"
                        [ngTemplateOutletContext]="{
                          props: {
                            icon: 'not_interested',
                            text: 'Declined'
                          }
                        }">
          </ng-container>
          <ng-container *ngIf="isApproved(site) && !requiresRenewal(site)"
                        [ngTemplateOutlet]="success_notification"
                        [ngTemplateOutletContext]="{
                          props: getApprovedSiteNotificationProperties(site)
                        }">
          </ng-container>
          <ng-container *ngIf="isApproved(site) && requiresRenewal(site)"
                        [ngTemplateOutlet]="notification"
                        [ngTemplateOutletContext]="{
                          props: getRenewalRequiredSiteNotificationProperties(organization.id, site)
                        }">
          </ng-container>
        </app-summary-card>

      </ng-container>
    </div>


  </ng-container>

  <ng-template #notification
               let-props="props">
    <div class="d-flex align-items-center mt-2">
      <div class="col d-flex align-items-center">
        <mat-icon class="mr-2"
                  color="warn">{{ props.icon }}</mat-icon>
        <span class="text-red">{{ props.text }}</span>
      </div>
      <button mat-flat-button
              color="primary"
              class="ml-auto"
              (click)="props.route()">{{ props.label }}</button>
    </div>
  </ng-template>

  <ng-template #success_notification
               let-props="props">
    <div class="d-flex align-self-center mt-2">
      <mat-icon class="mr-2 green-icon">{{ props.icon }}</mat-icon>
      <p class="text-green"
         [innerHTML]="props.text"></p>
    </div>
  </ng-template>

  <ng-template #organizationMenu
               let-organization="organization">
    <button mat-icon-button
            [matMenuTriggerFor]="rootMenu"
            [disabled]="orgHasPendingTransferOrClaim()">
      <mat-icon>more_vert</mat-icon>
    </button>

    <mat-menu #rootMenu="matMenu"
              aria-label="Organization actions menu">
      <button mat-menu-item
              (click)="viewOrganization(organization)">
        <span>View/Update Organization</span>
      </button>

      <button mat-menu-item
              [matMenuTriggerFor]="subMenu"
              [disabled]="!organizationAgreements?.length">
        <span>Download Organization Agreement</span>
      </button>
    </mat-menu>

    <mat-menu #subMenu="matMenu">
      <button *ngFor="let agreement of organizationAgreements"
              mat-menu-item
              (click)="viewAgreement(organization, agreement)">
        <span>{{ AgreementType[agreement.agreementType] | case: 'snake' : 'space' | capitalize: true }}</span>
      </button>
    </mat-menu>

  </ng-template>

  <ng-template #siteMenu
               let-site="site"
               let-organizationId="organizationId">
    <button mat-icon-button
            [matMenuTriggerFor]="menu"
            [disabled]="orgHasPendingTransferOrClaim()">
      <mat-icon>more_vert</mat-icon>
    </button>

    <mat-menu #menu="matMenu"
              aria-label="Site actions menu">
      <button mat-menu-item
              (click)="viewSite(organizationId, site)">
        <span>View/Update Site Information</span>
      </button>
      <button *ngIf="site.careSettingCode === CareSettingEnum.PRIVATE_COMMUNITY_HEALTH_PRACTICE"
              mat-menu-item
              [disabled]="!site.completed || site.status === SiteStatusType.IN_REVIEW"
              (click)="viewSiteRemoteUsers(organizationId, site)">
        <span>View/Update Remote Practitioners</span>
      </button>
    </mat-menu>
  </ng-template>

</app-page>
