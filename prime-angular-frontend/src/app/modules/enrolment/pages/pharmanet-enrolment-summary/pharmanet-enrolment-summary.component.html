<div class="app-print-layout">

  <app-enrollee-page [busy]="busy">

    <app-page-header>
      {{getTitle()}}
    </app-page-header>

    <app-enrolment-progress-indicator *ngIf="initialEnrolment"
                                      [inProgress]="!isEnrolmentComplete"
                                      [isCentered]="true"></app-enrolment-progress-indicator>

    <div class="row">

      <ng-container *ngIf="initialEnrolment; else renewalConfirmation">
        <div *ngIf="!isEnrolmentComplete"
             imageName="notification"
             class="col-12">
          <ng-container>
            <app-page-subheader [divider]="false">
              <ng-container appPageSubheaderTitle>Share your approval with your PharmaNet administrator</ng-container>
              <ng-container appPageSubheaderSummary>
                PRIME will send your enrolment information to your PharmaNet administrator(s).
                <div class="font-italic"
                     *ngIf="enrolment.currentStatus.statusCode === EnrolmentStatus.EDITABLE">
                  Note: You cannot access PharmaNet without completing this step. If necessary, you can leave this blank
                  and
                  return to PRIME later to enter the email(s).
                </div>
              </ng-container>
            </app-page-subheader>
          </ng-container>

          <ng-container *ngFor="let careSettingConfig of careSettingConfigs">
            <div class="mb-4">
              <ng-container [ngTemplateOutlet]="settingEmail"
                            [ngTemplateOutletContext]="careSettingConfig">
              </ng-container>
            </div>
          </ng-container>

          <div *ngIf="careSettingConfigs.length > 0"
               class="col col-sm-12 pt-2 text-right">
            <button mat-flat-button
                    type="button"
                    color="primary"
                    (click)="sendProvisionerAccessLinkTo()">
              Send Email
            </button>
          </div>
        </div>

        <ng-container *ngIf="isEnrolmentComplete">
          <div class="col-12">
            <ng-container>
              <p>
                You will need to renew your enrolment once a year, you will get an email reminding of your renewal date.
              </p>
            </ng-container>
            <ng-container>
              <p class="font-weight-bold">
                Your renewal date is: {{ enrolment.expiryDate | formatDate }}
                <br/>
                {{getAgreementDescription()}}
              </p>
            </ng-container>
            <ng-container appPageSubheaderSummary>
              <p><strong>Your PharmaNet Access</strong></p>
            </ng-container>
            <ng-container>
              <p>
                Access to PharmaNet is for professionals who care for patients as a key job duty. Your employer decides
                whether you need direct access to PharmaNet (they may instead prefer you consult medication records
                added to a patient's chart). Access to PharmaNet is granted through PRIME according to legislation and
                Ministry of Health policy.
              </p>
            </ng-container>
            <ng-container appPageSubheaderSummary>
              <p><strong>Global PharmaNet ID</strong></p>
            </ng-container>
            <ng-container>
              <p>
                PRIME has assigned you a global PharmaNet ID (GPID). This will be attached to all of your transactions
                in
                PharmaNet. It protects your information and patient information. If you ever need your GPID, you can
                sign
                in to PRIME to access it.
              </p>
            </ng-container>

            <ng-container [ngTemplateOutlet]="gpidSection">
            </ng-container>

          </div>
        </ng-container>
      </ng-container>
    </div>

    <ng-template #renewalConfirmation>
      <div imageName="notification"
           class="col-12">
        <ng-container appInfographicDescription>
          <p>
            Before you will be able to access PharmaNet, you must share your PRIME approval and provisioning details
            with the PharmaNet administrator for the site(s) where you wish to use PharmaNet. A PharmaNet administrator
            is the person in your workplace either sets up your PharmaNet access or confirms your request for someone
            else to set up access.
          </p>
          <p>
            If you need to complete a paper or electronic request form to request access to PharmaNet for your sites,
            please send the approval and provisioning details to yourself. You will need them to complete the form.
          </p>
        </ng-container>
        <ng-container appInfographicContent
                      *ngIf="enrolment.currentStatus.statusCode === EnrolmentStatus.EDITABLE">
          <p>
            To send the approval and provisioning details, enter the email address of your PharmaNet
            administrator(s)/yourself below.
          </p>
        </ng-container>

      </div>
      <ng-container *ngFor="let careSettingConfig of careSettingConfigs">
        <div class="col-12 mb-4">
          <ng-container [ngTemplateOutlet]="settingEmail"
                        [ngTemplateOutletContext]="careSettingConfig">
          </ng-container>
        </div>
      </ng-container>

      <div *ngIf="careSettingConfigs.length > 0"
           class="col col-sm-12 pt-2 text-right">
        <button mat-flat-button
                type="button"
                color="primary"
                (click)="sendProvisionerAccessLinkTo()">
          Send Email
        </button>

      </div>
      <div class="col">
        <ng-container *ngIf="!isNextStep || isEnrolmentComplete"
                      [ngTemplateOutlet]="gpidSection">
        </ng-container>
      </div>
    </ng-template>

    <ng-template #settingEmail
                 let-setting="setting"
                 let-settingPlural="settingPlural"
                 let-settingCode="settingCode"
                 let-healthAuthorityCode="healthAuthorityCode"
                 let-formArray="formArray"
                 let-formArrayName="formArrayName"
                 let-subheaderContent="subheaderContent">
      <app-page-subheader [divider]="false">
        <ng-container appPageSubheaderTitle>{{ setting }}</ng-container>
        <ng-container appPageSubheaderSummary>
          {{ subheaderContent }}
        </ng-container>
      </app-page-subheader>

      <form [formGroup]="emailForm">
        <div class="row">
          <div class="col col-12"
               [formArrayName]="formArrayName">
            <ng-container *ngFor="let email of formArray.controls; let i = index;"
                          [formGroupName]="i">
              <app-email-form [form]="email"
                              [index]="i"
                              [validateFormat]="true"
                              [showRemoveButton]="i>0"
                              [label]="getEmailLabel(i)"
                              (remove)="removeEmail(settingCode, healthAuthorityCode, $event)">
              </app-email-form>

              <div class="mb-2 remote_access_section"
                   formArrayName="sitesIds"
                   *ngIf="settingCode === CareSettingEnum.PRIVATE_COMMUNITY_HEALTH_PRACTICE && remoteAccessSites?.length > 0">
                <div class="title">Note: Remote Access to PharmaNet </div>
                <p>
                  If your clinic has registered you for remote access to PharmaNet, you must include the clinic
                  information in your provisioning details before remote access your PharmaNet administrator is
                  authorized
                  to set up remote access.
                </p>
                <p>
                  Tick the box beside the details you wish to send to the email address you have entered above.
                </p>
                <ng-container *ngFor="let siteControl of remoteAccessSites; let j = index">
                  <div class="col col-12">
                    <mat-checkbox [formControlName]="j">
                      {{getRemoteAccessSite(j).doingBusinessAs | default}} -
                      {{getRemoteAccessSite(j).physicalAddress?.street | default}}
                      {{getRemoteAccessSite(j).physicalAddress?.city | default}}
                      {{getRemoteAccessSite(j).physicalAddress?.provinceCode | default}}
                      {{getRemoteAccessSite(j).physicalAddress?.postal | default}}
                    </mat-checkbox>
                  </div>
                </ng-container>
                <br/>
              </div>
            </ng-container>
          </div>

          <div class="col col-sm-12">
            <button mat-button
                    type="button"
                    color="primary"
                    (click)="addEmptyEmailInput(settingCode, healthAuthorityCode)">
              <mat-icon>add</mat-icon>
              Add email of other PharmaNet administrator
            </button>
          </div>
        </div>
      </form>
    </ng-template>

    <ng-template #gpidSection>
      <section>
        <p>
          This is your GPID for your reference:
        </p>

        <strong>{{ GPID }}</strong>

        <button mat-icon-button
                type="button"
                aria-label="Copy your GPID to clipboard"
                matTooltip="Copy your GPID to clipboard"
                [cdkCopyToClipboard]="GPID"
                (cdkCopyToClipboardCopied)="onCopy()">
          <mat-icon>content_paste</mat-icon>
        </button>
      </section>
    </ng-template>
  </app-enrollee-page>

</div>
