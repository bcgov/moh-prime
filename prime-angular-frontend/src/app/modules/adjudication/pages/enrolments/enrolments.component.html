<app-page [busy]="busy"
          mode="full">

  <app-page-header>PharmaNet Enrolments</app-page-header>

  <div class="row justify-content-end">
    <div class="col text-right">
      <div class="row">
        <div class="col text-right pr-0">
          <app-search-form (search)="onSearch($event)"
                           (filter)="onFilter($event)">
          </app-search-form>
        </div>
        <div class="col-auto">
          <div class="d-flex align-items-center pb-3">
            <button class=""
                    mat-icon-button
                    matTooltip="Refresh the list of enrolments"
                    (click)="getEnrolments()">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <table mat-table
         [dataSource]="dataSource"
         class="w-100">

    <!-- Unique Id Column -->
    <ng-container matColumnDef="uniqueId">
      <th mat-header-cell
          *matHeaderCellDef> Unique Id </th>
      <td mat-cell
          *matCellDef="let enrolment;"> {{ enrolment.displayId }} </td>
    </ng-container>

    <!-- Name Column -->
    <ng-container matColumnDef="name">
      <th mat-header-cell
          *matHeaderCellDef> Enrollee Name </th>
      <td mat-cell
          *matCellDef="let enrolment;"> {{ enrolment.enrollee.firstName }}, {{ enrolment.enrollee.lastName }} </td>
    </ng-container>

    <!-- Approved Date Column -->
    <ng-container matColumnDef="approvedDate">
      <th mat-header-cell
          *matHeaderCellDef> Approval Date </th>
      <td mat-cell
          *matCellDef="let enrolment;"> {{ enrolment.approvedDate | formatDate | default }} </td>
    </ng-container>

    <!-- Applied Date Column -->
    <ng-container matColumnDef="appliedDate">
      <th mat-header-cell
          *matHeaderCellDef> Submission Date </th>
      <td mat-cell
          *matCellDef="let enrolment;"> {{ enrolment.appliedDate | formatDate }} </td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th mat-header-cell
          *matHeaderCellDef> Status </th>
      <td mat-cell
          *matCellDef="let enrolment;">
        <mat-chip-list>
          <mat-chip>{{ enrolment.currentStatus.status.name }}</mat-chip>
        </mat-chip-list>
      </td>
    </ng-container>

    <!-- Adjudicator Column -->
    <ng-container matColumnDef="adjudicator">
      <th mat-header-cell
          *matHeaderCellDef> Adjudicator </th>
      <td mat-cell
          *matCellDef="let enrolment;"> {{ enrolment.adjudicator?.firstName | default }} </td>
    </ng-container>

    <!-- Actions Column -->
    <ng-container matColumnDef="actions">
      <th mat-header-cell
          *matHeaderCellDef>&nbsp;</th>
      <td mat-cell
          *matCellDef="let enrolment;"
          class="text-right">

        <ng-container [ngTemplateOutlet]="menu"
                      [ngTemplateOutletContext]="{ enrolment: enrolment }"></ng-container>

      </td>
    </ng-container>

    <tr mat-header-row
        *matHeaderRowDef="columns; sticky: true"></tr>
    <tr mat-row
        *matRowDef="let row; columns: columns;"></tr>
  </table>

  <p *ngIf="!dataSource?.data.length"
     class="px-4 py-2 text-muted">
    No {{ filteredStatus?.name }} Enrolments
  </p>

  <ng-template #menu
               let-enrolment="enrolment">
    <button mat-icon-button
            [matMenuTriggerFor]="menu">
      <mat-icon>more_vert</mat-icon>
    </button>

    <mat-menu #menu="matMenu">
      <button mat-menu-item
              [routerLink]="[enrolment.id]">
        <mat-icon>remove_red_eye</mat-icon>
        <span>View Enrolment</span>
      </button>
      <button mat-menu-item
              (click)="viewEnrolmentHistory(enrolment.id)">
        <mat-icon>history</mat-icon>
        <span>View Enrolment History</span>
      </button>
      <button mat-menu-item
              (click)="viewAccessTermsHistory(enrolment.id)">
        <mat-icon>history</mat-icon>
        <span>View Access Terms History</span>
      </button>
      <button mat-menu-item
              *ngIf="enrolment.currentStatus.enrolmentStatusReasons.length"
              (click)="reviewStatusReasons(enrolment)">
        <mat-icon>flag</mat-icon>
        <span>Review Status Reasons</span>
      </button>
      <button mat-menu-item
              *ngIf="canApproveOrDeny(enrolment.currentStatus.statusCode)"
              (click)="approveEnrolment(enrolment)">
        <mat-icon>check_circle_outline</mat-icon>
        <span>Approve Enrolment</span>
      </button>
      <button mat-menu-item
              *ngIf="canApproveOrDeny(enrolment.currentStatus.statusCode)"
              (click)="declineEnrolment(enrolment.id)">
        <mat-icon>block</mat-icon>
        <span>Decline Enrolment</span>
      </button>
      <button mat-menu-item
              [routerLink]="[enrolment.id, 'adjudicator-notes']">
        <mat-icon>message</mat-icon>
        <span>Global Adjudicator Notes</span>
      </button>
      <button mat-menu-item
              *ngIf="isUnderReview(enrolment.currentStatus.statusCode)"
              [routerLink]="[enrolment.id, 'limits-conditions-clauses']">
        <mat-icon>description</mat-icon>
        <span>Limits and Conditions Clauses</span>
      </button>
      <button mat-menu-item
              *ngIf="canAllowEditing(enrolment.currentStatus.statusCode)"
              (click)="markForEditing(enrolment.id)">
        <mat-icon>undo</mat-icon>
        <span>Enable Editing</span>
      </button>
      <button mat-menu-item
              (click)="updateEnrolmentAdjudicator(enrolment)">
        <mat-icon>pan_tool</mat-icon>
        <span>{{ (enrolment?.adjudicatorId) ? 'Disclaim' : 'Claim' }} Enrolment</span>
      </button>
      <button mat-menu-item
              *ngIf="isSuperAdmin()"
              (click)="deleteEnrolment(enrolment.id)">
        <mat-icon>delete</mat-icon>
        <span>Delete Enrolment</span>
      </button>
    </mat-menu>
  </ng-template>

</app-page>
