---
apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: prime
  description: >-
    Deployment template for the BC Parks App
parameters:
- name: NAME
  displayName: Name
  description: A prefix appended to all objects
  required: true
  value: prime
- name: OC_NAMESPACE
  displayName: OpenShift License Plate
  description: Prepends your dev/test/prod URL
  required: true
  value: 9c33a9
- name: OC_APP
  displayName: Openshift Environment
  description: dev/test/prod
  required: true
- name: FRONTEND_POD
  displayName: Frontend Pod Name
  description: For naming the web/reverse proxy pod
  required: true
  value: frontend
- name: FRONTEND_URL
  displayName: Frontend URL
  description: Minus the HTTP/HTTPS, this is your vanity URL or the prefix of your default URL
  required: true
  value: frontend
- name: API_POD
  displayName: API Pod Name
  description: For the .NET API
  required: true
  value: webapi
- name: ASP_ENV
  displayName: ASP.NET Environment
  description: Development or Production
  required: true
  value: Development
- name: DOCMAN_POD
  displayName: Document Manager Pod Name
  description: For other pods to reference it
  required: true
  value: document-manager
- name: DB_POD
  displayName: Database Pod
  description: Postgres database
  required: true
  value: postgres
- name: REDIS_POD
  displayName: Redis Pod
  description: Redis in-memory database
  value: redis
- name: WEB_SCHEMA
  displayName: Web Schema
  description: http OR https
  value: http
- name: URL_STUB
  displayName: URL Stub
  description: Appended to all URLs, used in PRs
  value: "9c33a9-dev.apps.silver.devops.gov.bc.ca"
  required: false
objects:
###########################################
###               Frontend              ###
###########################################
#   Frontend Deployment Config
- apiVersion: apps.openshift.io/v1
  kind: DeploymentConfig
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${FRONTEND_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
      app.openshift.io/runtime: nginx
  spec:
    completionDeadlineSeconds: 1200
    replicas: 1
    selector:
      name: ${NAME}-${FRONTEND_POD}
    strategy:
      type: Recreate
      maxSurge: 50%
      maxUnavailable: 0
    template:
      metadata:
        labels:
          dev-app: ${NAME}
          name: ${NAME}-${FRONTEND_POD}
      spec:
        containers:
          - name: ${NAME}-${FRONTEND_POD}
            image: >-
              image-registry.openshift-image-registry.svc:5000/${OC_NAMESPACE}-tools/prime-frontend:${NAME}
            ports:
              - containerPort: 80
                protocol: TCP
              - containerPort: 8080
                protocol: TCP
              - containerPort: 8443
                protocol: TCP
            resources:
              limits:
                cpu: 500m
                memory: 512Mi
              requests:
                cpu: 250m
                memory: 256Mi
            envFrom:
            - configMapRef:
                name: keycloak
    triggers:
      - type: ConfigChange
      - type: ImageChange
        imageChangeParams:
          automatic: true
          containerNames:
            - ${NAME}-${FRONTEND_POD}
          from:
            kind: ImageStreamTag
            namespace: "${OC_NAMESPACE}-tools"
            name: 'prime-frontend:${NAME}'
  status: {}
#   Frontend Service
- apiVersion: v1
  kind: Service
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${FRONTEND_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
  spec:
    ports:
      - name: "http"
        port: 8080
        targetPort: 8080
      - name: "https"
        port: 8443
        targetPort: 8443
    selector:
      name: ${NAME}-${FRONTEND_POD}
#   Frontend Route
- apiVersion: route.openshift.io/v1
  kind: Route
  namespace: ${OC_NAMESPACE}-${OC_APP}
  labels:
    app: ${NAME}-${FRONTEND_POD}
    app.kubernetes.io/component: ${NAME}
    app.kubernetes.io/instance: ${NAME}
    app.kubernetes.io/part-of: ${NAME}
  metadata:
    name: ${NAME}-${FRONTEND_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
  spec:
    host: ${FRONTEND_URL}${NAME}${URL_STUB}
    to:
      kind: Service
      name: ${NAME}-${FRONTEND_POD}
      weight: 100
    port:
      targetPort: ${WEB_SCHEMA}
    tls:
      termination: edge
      insecureEdgeTerminationPolicy: Redirect
    wildcardPolicy: None

###########################################
###           Backend Web API           ###
###########################################
#   Backend Web API Deployment Config
- apiVersion: apps.openshift.io/v1
  kind: DeploymentConfig
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${API_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
      app.openshift.io/runtime: dotnet
  spec:
    completionDeadlineSeconds: 1200
    replicas: 1
    selector:
      name: ${NAME}-${API_POD}
    strategy:
      type: Recreate
      maxSurge: 50%
      maxUnavailable: 0
    template:
      metadata:
        labels:
          dev-app: ${NAME}
          name: ${NAME}-${API_POD}
      spec:
        containers:
          - name: ${NAME}-${API_POD}
            image: >-
              image-registry.openshift-image-registry.svc:5000/${OC_NAMESPACE}-tools/prime-webapi-backend:${NAME}
            env:
              - name: DOCUMENT_MANAGER_CLIENT_ID
                valueFrom:
                  configMapKeyRef:
                    name: document-manager
                    key: DOCUMENT_MANAGER_CLIENT_ID
              - name: PHARMANET_SSL_CERT_FILENAME
                value: /opt/app-root/etc/certs/pharmanet-api-cert.pfx
              - name: PGPASSWORD
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_PASSWORD
              - name: POSTGRESQL_DATABASE
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_USERNAME
              - name: POSTGRESQL_USER
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_USERNAME
              - name: POSTGRESQL_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_PASSWORD
              - name: POSTGRESQL_ADMIN_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_PASSWORD
            ports:
              - containerPort: 1025
                protocol: TCP
              - containerPort: 5001
                protocol: TCP
              - containerPort: 8080
                protocol: TCP
            imagePullPolicy: IfNotPresent
            terminationMessagePolicy: File
            envFrom:
              - configMapRef:
                  name: canada-post-addresscomplete
              - configMapRef:
                  name: ches
              - configMapRef:
                  name: dotnet-webapi-backend
              - configMapRef:
                  name: keycloak
              - configMapRef:
                  name: ldap
              - configMapRef:
                  name: metabase-embedded
              - configMapRef:
                  name: pharmanet-api
              - configMapRef:
                  name: verifiable-credential
              - secretRef:
                  name: canada-post-addresscomplete-secrets
              - secretRef:
                  name: ches-secrets
              - secretRef:
                  name: document-manager-secrets
              - secretRef:
                  name: keycloak-secrets
              - secretRef:
                  name: metabase-embedded-secrets
              - secretRef:
                  name: pharmanet-api-secrets
              - secretRef:
                  name: pharmanet-api-ssl-certs
              - secretRef:
                  name: verifiable-credential-secrets
            volumeMounts:
              - name: cert-volume
                mountPath: /opt/app-root/etc/certs
                readOnly: true
        volumes:
          - name: cert-volume
            secret:
              secretName: pharmanet-api-ssl-certs
    triggers:
      - type: ConfigChange
      - type: ImageChange
        imageChangeParams:
          automatic: true
          containerNames:
            - ${NAME}-${API_POD}
          from:
            kind: ImageStreamTag
            namespace: "${OC_NAMESPACE}-tools"
            name: 'prime-webapi-backend:${NAME}'
  status: {}
#   Backend Web API Service
- apiVersion: v1
  kind: Service
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${API_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
  spec:
    ports:
      - name: ${NAME}-${API_POD}
        port: 5001
        targetPort: 5001
    selector:
      name: ${NAME}-${API_POD}

###########################################
###      Document Manager (backend)     ###
###########################################
#   Document Manager (backend) Deployment Config
- apiVersion: apps.openshift.io/v1
  kind: DeploymentConfig
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${DOCMAN_POD}-backend
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
      app.openshift.io/runtime: python
  spec:
    completionDeadlineSeconds: 1200
    replicas: 1
    selector:
      name: ${NAME}-${DOCMAN_POD}-backend
    strategy:
      type: Recreate
      maxSurge: 50%
      maxUnavailable: 0
    template:
      metadata:
        labels:
          dev-app: ${NAME}
          name: ${NAME}-${DOCMAN_POD}-backend
      spec:
        containers:
          - name: ${NAME}-${DOCMAN_POD}-backend
            image: >-
              image-registry.openshift-image-registry.svc:5000/${OC_NAMESPACE}-tools/prime-document-manager:${NAME}
            env:
              - name: CACHE_REDIS_HOST
                value: redis
              - name: CACHE_REDIS_PASS
                valueFrom:
                  secretKeyRef:
                    name: redis
                    key: database-password
              - name: CACHE_REDIS_PORT
                valueFrom:
                  configMapKeyRef:
                    name: redis
                    key: redis_port
              - name: DB_HOST
                value: ${NAME}-{DB_POD}-db
              - name: DB_NAME
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_USERNAME
              - name: DB_PASS
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_PASSWORD
              - name: DB_PORT
                valueFrom:
                  configMapKeyRef:
                    name: postgresql
                    key: postgresql_database_port
              - name: DB_USER
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_USERNAME
              - name: FLASK_ENV
                valueFrom:
                  configMapKeyRef:
                    name: document-manager
                    key: FLASK_ENV
              - name: FLASK_RUN_HOST
                valueFrom:
                  configMapKeyRef:
                    name: document-manager
                    key: FLASK_RUN_HOST
              - name: FLASK_DEBUG
                valueFrom:
                  configMapKeyRef:
                    name: document-manager
                    key: FLASK_DEBUG
              - name: FLASK_APP
                valueFrom:
                  configMapKeyRef:
                    name: document-manager
                    key: FLASK_APP
              - name: FLASK_RUN_PORT
                valueFrom:
                  configMapKeyRef:
                    name: document-manager
                    key: FLASK_RUN_PORT
              - name: JWT_WELL_KNOWN_CONFIG
                valueFrom:
                  configMapKeyRef:
                    name: keycloak
                    key: JWT_WELL_KNOWN_CONFIG
              - name: PGPASSWORD
                valueFrom:
                  secretKeyRef:
                    name: postgres-secrets
                    key: DATABASE_PASSWORD
            ports:
              - containerPort: 6001
                protocol: TCP
              - containerPort: 9191
                protocol: TCP
    triggers:
      - type: ConfigChange
      - type: ImageChange
        imageChangeParams:
          automatic: true
          containerNames:
            - ${NAME}-${DOCMAN_POD}-backend
          from:
            kind: ImageStreamTag
            namespace: "${OC_NAMESPACE}-tools"
            name: 'prime-document-manager:${NAME}'
  status: {}
#   Document Manager (backend) Service
- apiVersion: v1
  kind: Service
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${DOCMAN_POD}-backend
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
  spec:
    ports:
      - name: ${NAME}-${DOCMAN_POD}-backend
        port: 6001
        targetPort: 6001
    selector:
      name: ${NAME}-${DOCMAN_POD}-backend

###########################################
###     Document Manager (Migration)    ###
###########################################
### Document Manager (Migration) Deployment Config
### Used for Alembic to run database migrations against the PostgreSQL database 
### for all Document Manager related tables. This pod will run once PostgreSQL 
### is verified to be open to query connections.
- apiVersion: batch/v1
  kind: Job
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${DOCMAN_POD}-migration
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
      app.openshift.io/runtime: python
  spec:
    template:
      metadata:
        labels:
          dev-app: ${NAME}
          name: ${NAME}-${DOCMAN_POD}-migration
      spec:
        restartPolicy: OnFailure
        containers:
        - name: ${NAME}-${DOCMAN_POD}-migration
          image: >-
            image-registry.openshift-image-registry.svc:5000/${OC_NAMESPACE}-tools/prime-document-manager:${NAME}
          command:
            # Script force waits migration pod execution until PostgreSQL is verified to 
            # be open to query connections.
            - /opt/app-root/src/app.sh
          args: 
            - migrate
          env:
            - name: CACHE_REDIS_HOST
              value: redis
            - name: CACHE_REDIS_PASS
              valueFrom:
                secretKeyRef:
                  name: redis
                  key: database-password
            - name: CACHE_REDIS_PORT
              valueFrom:
                configMapKeyRef:
                  name: redis
                  key: redis_port
            - name: DB_HOST
              value: ${NAME}-${DB_POD}
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secrets
                  key: DATABASE_USERNAME
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: postgres-secrets
                  key: DATABASE_PASSWORD
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: postgresql
                  key: postgresql_database_port
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secrets
                  key: DATABASE_USERNAME
            - name: FLASK_ENV
              valueFrom:
                configMapKeyRef:
                  name: document-manager
                  key: FLASK_ENV
            - name: FLASK_RUN_HOST
              valueFrom:
                configMapKeyRef:
                  name: document-manager
                  key: FLASK_RUN_HOST
            - name: FLASK_DEBUG
              valueFrom:
                configMapKeyRef:
                  name: document-manager
                  key: FLASK_DEBUG
            - name: FLASK_APP
              valueFrom:
                configMapKeyRef:
                  name: document-manager
                  key: FLASK_APP
            - name: FLASK_RUN_PORT
              valueFrom:
                configMapKeyRef:
                  name: document-manager
                  key: FLASK_RUN_PORT
            - name: JWT_WELL_KNOWN_CONFIG
              valueFrom:
                configMapKeyRef:
                  name: keycloak
                  key: JWT_WELL_KNOWN_CONFIG
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secrets
                  key: DATABASE_PASSWORD
    triggers:
      - type: ConfigChange
      - type: ImageChange
        imageChangeParams:
          automatic: true
          containerNames:
            - ${NAME}-${DOCMAN_POD}-migration
          from:
            kind: ImageStreamTag
            namespace: "${OC_NAMESPACE}-tools"
            name: 'prime-document-manager:${NAME}'
  status: {}

###########################################
###         PostgreSQL Database         ###
###########################################
#   PostgreSQL database Deployment Config
- apiVersion: apps.openshift.io/v1
  kind: DeploymentConfig
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${DB_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
      app.openshift.io/runtime: postgresql
  spec:
    replicas: 1
    selector:
      name: ${NAME}-${DB_POD}
    strategy: null
    template:
      metadata:
        labels:
          dev-app: ${NAME}
          name: ${NAME}-${DB_POD}
      spec:
        containers:
          - capabilities: {}
            env:
              - name: DB_HOST
                value: ${NAME}-${DB_POD}
              # PostgreSQL environment variables
              - name: PGPASSWORD
                valueFrom:
                  secretKeyRef:
                    key: DATABASE_PASSWORD
                    name: postgres-secrets
              - name: POSTGRESQL_USER
                valueFrom:
                  secretKeyRef:
                    key: DATABASE_USERNAME
                    name: postgres-secrets
              - name: POSTGRESQL_PASSWORD
                valueFrom:
                  secretKeyRef:
                    key: DATABASE_PASSWORD
                    name: postgres-secrets
              - name: POSTGRESQL_DATABASE
                valueFrom:
                  secretKeyRef:
                    key: DATABASE_USERNAME
                    name: postgres-secrets
            image: >-
              image-registry.openshift-image-registry.svc:5000/openshift/postgresql:10
            imagePullPolicy: IfNotPresent
            lifecycle:
              preStop:
                exec:
                  command: ['pg_ctl', 'stop']
            livenessProbe:
              initialDelaySeconds: 30
              tcpSocket:
                port: 5432
              timeoutSeconds: 1
            name: ${NAME}-${DB_POD}
            ports:
              - containerPort: 5432
                protocol: TCP
                name: postgresql
            resources: {}
            securityContext:
              capabilities: {}
              privileged: false
            terminationMessagePath: /dev/termination-log
            volumeMounts:
              - mountPath: /var/lib/pgsql/data
                name: ${NAME}-${DB_POD}-data
              - mountPath: /var/run/postgresql
                name: ${NAME}-${DB_POD}-run
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        volumes:
          - name: ${NAME}-${DB_POD}-data
            emptyDir: {}
          - name: ${NAME}-${DB_POD}-run
            emptyDir: {}
  status: {}
#   PostgreSQL Service
- apiVersion: v1
  kind: Service
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${DB_POD}
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
  spec:
    ports:
      - name: ${NAME}-${DB_POD}
        nodePort: 0
        port: 5432
        protocol: TCP
        targetPort: 5432
    selector:
      name: ${NAME}-${DB_POD}
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}

###########################################
###                Redis                ###
###########################################
#   Redis Deployment Config
- apiVersion: apps.openshift.io/v1
  kind: DeploymentConfig
  namespace: ${OC_NAMESPACE}-${OC_APP}
  metadata:
    name: ${NAME}-${REDIS_POD}-cache
    namespace: ${OC_NAMESPACE}-${OC_APP}
    labels:
      app.kubernetes.io/part-of: ${NAME}
      app.openshift.io/runtime: redis
  spec:
    completionDeadlineSeconds: 1200
    replicas: 1
    selector:
      name: ${NAME}-${REDIS_POD}-cache
    strategy:
      type: Recreate
      maxSurge: 50%
      maxUnavailable: 0
      recreateParams:
        timeoutSeconds: 600
      activeDeadlineSeconds: 21600
    template:
      metadata:
        labels:
          dev-app: ${NAME}
          name: ${NAME}-${REDIS_POD}-cache
      spec:
        volumes:
          - name: ${NAME}-${REDIS_POD}-cache-data
            emptyDir: {}
        containers:
          - resources:
              limits:
                memory: 512Mi
            readinessProbe:
              exec:
                command:
                  - /bin/sh
                  - '-i'
                  - '-c'
                  - >-
                    test "$(redis-cli -h 127.0.0.1 -a $REDIS_PASSWORD ping)" ==
                    "PONG"
              initialDelaySeconds: 5
              timeoutSeconds: 1
              periodSeconds: 10
              successThreshold: 1
              failureThreshold: 3
            terminationMessagePath: /dev/termination-log
            name: redis
            livenessProbe:
              tcpSocket:
                port: 6379
              initialDelaySeconds: 30
              timeoutSeconds: 1
              periodSeconds: 10
              successThreshold: 1
              failureThreshold: 3
            env:
              - name: REDIS_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: redis
                    key: database-password
            securityContext:
              capabilities: {}
              privileged: false
            ports:
              - containerPort: 6379
                protocol: TCP
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - name: ${NAME}-redis-cache-data
                mountPath: /var/lib/redis/data
            terminationMessagePolicy: File
            image: >-
              image-registry.openshift-image-registry.svc:5000/openshift/redis:5
        restartPolicy: Always
        dnsPolicy: ClusterFirst


###########################################
###           Network Policies          ###
###########################################
- apiVersion: networking.k8s.io/v1
  kind: NetworkPolicy
  metadata:
    name: allow-internal-traffic
    namespace: ${OC_NAMESPACE}-${OC_APP}
  spec:
    podSelector: {}
    ingress:
      - ports:
          - protocol: TCP
            port: 80
          - protocol: TCP
            port: 5001
          - protocol: TCP
            port: 5432
          - protocol: TCP
            port: 6001
          - protocol: TCP
            port: 8080
          - protocol: TCP
            port: 9191
    policyTypes:
      - Ingress