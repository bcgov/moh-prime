## Running the Aries Agent Locally for Verifiable Credential Testing and Development

**NOTE:** The following process is only necessary when working with Verifiable Credential Testing and Development, and is not necessary for general development purposes; for example, when initially setting up the project.

To run the project you will need to open two terminals:

- one terminal in the [ngrok](../ngrok) folder: run the [start-ngrok.sh](../ngrok/start-ngrok.sh) script, this will initialize an ngrok tunnel that will be used to forward requests to your agent.

- uncomment `agent` and `wallet` servies defined in [docker-compose.yml](../docker-compose.yml). These must be run through the manage script to populate the required environment variables, and CANNOT be started doing docker-compose up --build alone.

- one terminal in the [moh-prime]root folder: run `./manage start`. This will start all of the services defined in [docker-compose.yml](../docker-compose.yml).

Once started the agent services will be listening on localhost as follows:
- `agent`: http://localhost:8024 (admin API).
- `db` and `wallet` postgres databases will respectively be listening on ports `5432` and `5434`.

You can always run `./manage -h` to get more information about the usage of the script, and refer to it to find values for environment variables being set and consumed by `docker-compose`.

**Please Note:** when starting the project, a `.env` file containing the agent wallet seed will be generated in the [moh-prime] folder. Do not edit this file manually, as its contents are used by the services to persist the agent's information and will be handled automatically by the `manage` script.



Common Issues
- When stopping and removing an agent and wallet and then restarting it, you may get an error saying `New seed provided which doesn't match the registered public did`, if this happens, delete the volumes for the wallet, run `./manage rm` again and then try `./manage start` again.

- If the wallet keeps giving the message `An error has occured`, when you scan the qr code, try restarting ngrok, and then restarting the agent. It goes stale after a few hours and prevents your phone from talking to the agent.


## Updating the schema
To update the schema:
- Add or update the fields in the [CredentialPayload.cs](../Models/VerifiableCredentials/CredentialPayload.cs). Ensure the JsonProperty looks how you want the name to appear on the Credential.
- Increment the SchemaVersion under VerifiableCredentialApi in [PrimeEnvironment.cs](../PrimeEnvironment.cs).
- In local development, this change will take place in the agent automatically when the agent and webapi are restarted.   On startup the schema is created, and then the credential definition is created.
- In dev, test, and prod, the schema and credential definition will have to be updated manually through postman or through the swagger UI as the code is pushed to each environment. You will also have to send the DTS team the updated schema information so that they can update the verifiers.
- dev swagger: https://prime-agent-admin-dev.apps.silver.devops.gov.bc.ca/api/doc
- test swagger: https://prime-agent-admin-test.apps.silver.devops.gov.bc.ca/api/doc
- prod swagger: https://prime-agent-admin.apps.silver.devops.gov.bc.ca/api/doc

Send the updated schema: https://prime-agent-admin-dev.apps.silver.devops.gov.bc.ca/api/doc#/schema/post_schemas

Using the schema id created in the previous step, then create the credential definition (support_revocation = true, tag = prime)
https://prime-agent-admin-dev.apps.silver.devops.gov.bc.ca/api/doc#/credential-definition/post_credential_definitions
