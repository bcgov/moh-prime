apiVersion: template.openshift.io/v1
kind: Template
metadata:
  annotations:
    description: Template for job that curls your api
    tags: cronjob
  creationTimestamp: '2021-01-06T18:51:11Z'
  name: cronjob-template
  namespace: dqszvc-dev
  resourceVersion: '2440024327'
  selfLink: >-
    /apis/template.openshift.io/v1/namespaces/dqszvc-dev/templates/cronjob-template
  uid: 251e0532-5050-11eb-9613-0050568348cc
objects:
  - apiVersion: batch/v1beta1
    kind: CronJob
    metadata:
      name: '${CRON_NAME}'
    spec:
      concurrencyPolicy: Forbid
      jobTemplate:
        spec:
          template:
            spec:
              containers:
                - command:
                    - bash
                    - '-c'
                    - >-
                      echo -e "-------- STARTING CRON --------\n"    echo -e
                      "-------- GETTING ACCESS TOKEN --------\n"

                      TOKEN=$(curl -X POST
                      "${KEYCLOAK_URL}/realms/${KEYCLOAK_REALM}/protocol/openid-connect/token"
                      \
                        -H "Content-Type: application/x-www-form-urlencoded" \
                        -d "grant_type=client_credentials" \
                        -d "client_id=${KEYCLOAK_CLIENT_ID}" \
                        -d "client_secret=${KEYCLOAK_CLIENT_SECRET}" | python -c "import sys, json; print json.load(sys.stdin)['access_token']")

                      echo -e ${TOKEN}

                      echo -e "-------- Calling PRIME --------\n"

                      curl -X POST
                      https://develop.pharmanetenrolment.gov.bc.ca/api/v1/Emails/management/enrollees/renewal
                      \
                        -H "Authorization: Bearer ${TOKEN}" \
                        -H "Content-Type: application/json" \

                      echo -e "-------- CRON COMPLETE --------\n"
                  env:
                    - name: KEYCLOAK_CLIENT_SECRET
                      valueFrom:
                        secretKeyRef:
                          key: prime_service_account_client_secret
                          name: prime-service-account
                    - name: KEYCLOAK_CLIENT_ID
                      valueFrom:
                        secretKeyRef:
                          key: prime_service_account_client_id
                          name: prime-service-account
                    - name: KEYCLOAK_URL
                      valueFrom:
                        secretKeyRef:
                          key: KEYCLOAK_URL
                          name: keycloak
                    - name: KEYCLOAK_REALM
                      valueFrom:
                        secretKeyRef:
                          key: KEYCLOAK_REALM
                          name: keycloak
                  image: >-
                    docker-registry.default.svc:5000/openshift/base-centos7:latest
                  limits:
                    cpu: 500m
                    memory: 2Gi
                  name: '${CRON_NAME}'
                  requests:
                    cpu: 100m
                    memory: 512Mi
                  resources: null
              restartPolicy: Never
      schedule: '${CRON_SCHEDULE}'
parameters:
  - description: 'Cron-like schedule expression. Default: Once every day at 12:00 AM'
    name: CRON_SCHEDULE
    value: '*/5 * * * *'
  - name: CRON_NAME
    value: prime-api-vX-cronjob
